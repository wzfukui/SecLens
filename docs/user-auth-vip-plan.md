# 用户注册 / VIP / 订阅功能实施计划

## 背景与目标
- 在现有 SecLens 平台中引入邮箱注册登录体系，使用户能够访问个人主页与控制台。
- 结合外部售卖的激活码体系，管理用户 VIP 身份及有效期。
- 支持用户自定义通知渠道（Webhook、邮件），以及基于关键词的推送规则。
- 支持用户组合插件渠道与关键词创建订阅，并为每个订阅生成专属 RSS 地址。

## 范围
- **包含**：后端数据模型、API、后台任务、邮件/Webhook 通知触发、前端页面与控制台交互、订阅链接生成与鉴权。
- **不包含**：外部电商平台购买流程、实际支付接口、详细的运营后台管理界面。

## 关键设计要点
- 邮箱密码使用安全哈希（建议 `passlib`/`bcrypt`），并使用基于 JWT 的认证令牌。
- 激活码以一次性 token 形式存储，状态流转：`未使用 -> 已使用`，并记录激活人、激活时间。
- VIP 有效期按 UTC 存储，激活时最长顺延至当前到期日之后一年。
- 通知配置、订阅配置均挂载在 User 下，关键字段使用 JSON/关联表表示，便于扩展。
- RSS 订阅 URL 携带签名 token（使用 HMAC + 随机密钥），避免泄露规则详情。
- 推送规则触发引擎与订阅生成逻辑在后端服务层实现，未来可扩展为后台任务。

## 工作分解

### 第一阶段：基础认证与用户模型
1. 新增数据库模型：
   - `users`（邮箱、密码哈希、昵称、创建/更新时间、vip 激活时间、vip 到期时间等）。
   - `activation_codes`（code、状态、批次、使用人、使用时间、有效期）。
2. 新增 Pydantic Schema、CRUD 操作。
3. 引入 JWT 认证模块（加入 `python-jose`、`passlib[bcrypt]` 依赖）。
4. 实现注册、登录、刷新令牌、个人中心获取接口。
5. 更新 `/login` 页面 → 邮箱登录表单；新增注册流程页面/接口。

### 第二阶段：VIP 激活与控制台配置
1. 新增激活码验证 API，校验并更新用户 VIP 有效期。
2. 控制台新增展示 VIP 状态（到期时间、剩余天数）。
3. 控制台表单支持配置：
   - Webhook URL（校验合法 URL）。
   - 通知邮箱（可复用用户邮箱或自定义）。
4. 在用户模型/附表中存储通知设置（`user_notification_settings`）。

### 第三阶段：推送规则与关键词触发
1. 新增 `user_push_rules` 表（所属用户、关键词、启停状态、触发渠道等）。
2. 后端服务在信息采集后（或模拟后台任务）匹配关键词，命中时调用通知服务：
   - Webhook：POST JSON payload。
   - 邮件：暂时可保留占位实现或调用现有邮件服务接口。
3. 前端控制台提供推送规则管理（列表、创建、编辑、删除、启停）。

### 第四阶段：自定义 RSS 订阅
1. 数据结构：
   - `user_subscriptions`（名称、渠道组合、关键词配置、生成的 token、状态）。
   - `user_subscription_channels`（关联插件 slug）。
2. 提供生成/刷新订阅地址的 API（`/rss/{token}` 形式）。
3. RSS 生成器读取订阅规则，过滤资讯并返回 RSS XML，后端路由新增 `/rss/{token}`。
4. 控制台 UI 支持：
   - 选择插件渠道（复选）。
   - 输入订阅关键词（可选）。
   - 展示订阅链接（含复制）。

### 第五阶段：前端整合与用户主页
1. 用户登录后跳转个人主页（概览：VIP 状态、最近推送、订阅统计）。
2. 控制台分 Tab 展示通知设置、推送规则、订阅管理。
3. 处理未登录访问控制（重定向至登录页）。

## 技术与依赖调整
- `requirements.txt` 增加 `python-jose[cryptography]`、`passlib[bcrypt]`、`email-validator`。
- `frontend` 侧若使用打包构建，需要同步更新依赖/接口调用层。
- 若需要发送邮件，考虑引入异步任务或第三方服务客户端（暂留 TODO）。

## 验收与测试
- 单元测试：
  - 用户注册/登录流程。
  - 激活码使用规则（重复使用、过期、顺延周期）。
  - 推送规则匹配与调用（可 mock 外部请求/邮件）。
  - RSS token 鉴权、规则过滤。
- 集成测试：
  - 整体登录 → 控制台配置 → 创建订阅 → 拉取 RSS。
  - 登录态保护的 API 返回 401/403。
- 手工测试：UI 表单、通知配置保存、激活码操作、RSS 链接可订阅。

## 里程碑建议
1. **M1（基础用户体系）**：完成阶段一 & 阶段二，提供可登录的控制台和 VIP 激活。
2. **M2（通知与推送规则）**：完成阶段三，实现关键词触发与通知。
3. **M3（订阅体系）**：完成阶段四 & 阶段五，开放自定义订阅与主页体验。

