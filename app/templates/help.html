{% extends "base.html" %}
{% block content %}
<section class="static-page">
    <h2>平台工作流程</h2>
    <ol>
        <li><strong>开发插件</strong>：在本地实现采集逻辑（示例参考仓库中的 <code>collectors.aliyun</code> 模块）。</li>
        <li><strong>打包注册</strong>：将代码和 manifest 压缩成 ZIP，并通过 <code>POST /v1/plugins/upload</code> 提交。</li>
        <li><strong>审核激活</strong>：调用 <code>POST /v1/plugins/{id}/activate</code>，确认 schedule、运行状态。</li>
        <li><strong>自动调度</strong>：运行 <code>python scripts/run_scheduler.py</code> 周期执行激活的插件。</li>
        <li><strong>数据入库/展示</strong>：插件内部调用 ingest API 写入公告表，首页、RSS、API 实时提供结构化信息。</li>
    </ol>
    <p>如需接入现有调度系统，可将调度脚本封装为 Cron/Airflow 任务执行。</p>

    <h3>完整插件示例（基于阿里云实现）</h3>
    <p>目录结构：</p>
    <pre><code>aliyun.zip
├── manifest.json
└── collectors
    ├── __init__.py
    └── aliyun.py</code></pre>

    <p><code>manifest.json</code></p>
    <pre><code>{
  "slug": "aliyun_security",
  "name": "Aliyun Bulletin Collector",
  "version": "1.0.0",
  "entrypoint": "collectors.aliyun:run",
  "description": "采集阿里云安全公告",
  "schedule": "3600",                         // 每 3600 秒运行一次
  "runtime": {
    "ingest_url": "http://127.0.0.1:8000/v1/ingest/bulletins",
    "token": "<可选 API Token>"
  }
}</code></pre>

    <p><code>collectors/aliyun.py</code>（核心片段）</p>
    <pre><code>API_URL = "https://t.aliyun.com/abs/bulletin/bulletinQuery"

@dataclass(slots=True)
class FetchParams:
    page_no: int = 1
    page_size: int = 50
    bulletin_type: str = "security"

class AliyunCollector:
    def fetch(self, params: FetchParams) -> list[dict]:
        response = requests.get(
            API_URL,
            params={"pageNo": params.page_no, "pageSize": params.page_size, "bulletinType": params.bulletin_type},
            timeout=30,
        )
        response.raise_for_status()
        return response.json().get("data", {}).get("info", [])

    def normalize(self, item: dict) -> BulletinCreate:
        return BulletinCreate(
            source=SourceInfo(
                source_slug="aliyun_security",
                external_id=str(item.get("id")),
                origin_url=item.get("url"),
            ),
            content=ContentInfo(
                title=item.get("titleFill") or item.get("title"),
                summary=item.get("summary"),
                body_text=item.get("content"),
                published_at=_parse_publish_time(item.get("publishTime")),
                language=item.get("language"),
            ),
            severity=item.get("securityLevel"),
            labels=[value for value in [item.get("bulletinType"), item.get("bulletinType2")] if value],
            topics=["official_bulletin"],
            extra={
                "bulletin_type": item.get("bulletinType"),
                "impact_time": item.get("impactTime"),
                "ext_info": json.loads(item.get("extInfo", "{}")),
            },
            raw=item,
        )

    def collect(self, params: FetchParams | None = None) -> list[BulletinCreate]:
        params = params or FetchParams()
        return [self.normalize(item) for item in self.fetch(params)]


def run(ingest_url: str | None = None, token: str | None = None, **runtime):
    collector = AliyunCollector()
    bulletins = collector.collect()
    if ingest_url:
        payload = [b.model_dump(mode="json") for b in bulletins]
        headers = {"Content-Type": "application/json"}
        if token:
            headers["Authorization"] = f"Bearer {token}"
        requests.post(ingest_url, json=payload, headers=headers, timeout=30)
    return bulletins
</code></pre>

    <h3>上传步骤</h3>
    <ol>
        <li>压缩：<code>zip -r aliyun.zip manifest.json collectors/</code></li>
        <li>Base64 编码：<code>base64 aliyun.zip &gt; payload.b64</code></li>
        <li>调用接口：</li>
    </ol>
    <pre><code>curl -X POST http://127.0.0.1:8000/v1/plugins/upload \
  -H "Content-Type: application/json" \
  -d '{
        "filename": "aliyun.zip",
        "content": "$(cat payload.b64)"
      }'</code></pre>

    <h3>激活与调度</h3>
    <p>上传成功后：</p>
    <pre><code># 查看状态
curl http://127.0.0.1:8000/v1/plugins

# 激活（需 manifest 提供 schedule）
curl -X POST http://127.0.0.1:8000/v1/plugins/1/activate -d '{"activate": true}' -H "Content-Type: application/json"

# 运行调度器（可加入 Cron）
python scripts/run_scheduler.py --ingest-url http://127.0.0.1:8000/v1/ingest/bulletins
</code></pre>
    <p>调度器会生成 <code>plugin_runs</code> 记录，包含开始/结束时间、状态、输出等信息。</p>
</section>
{% endblock %}
