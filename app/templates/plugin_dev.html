{% extends "base.html" %}
{% block content %}
<section class="static-page">
    <h2>插件开发指南</h2>
    <ol>
        <li><strong>开发插件</strong>：在 <code>resources/&lt;slug&gt;/</code> 目录内实现 <code>collector.py</code> 和 <code>manifest.json</code>（可参考 <code>resources.aliyun_security</code>）。</li>
        <li><strong>本地验证</strong>：运行 <code>pytest tests/collectors/test_*.py</code> 并使用 <code>python scripts/run_plugin.py --source &lt;slug&gt;</code> 做端到端检查。</li>
        <li><strong>打包</strong>：执行 <code>python scripts/package_plugins.py</code> 一键生成 <code>slug-version.zip</code>，必要时可带 <code>--upload-url</code> 自动上传。</li>
        <li><strong>上传激活</strong>：调用 <code>POST /v1/plugins/upload</code> 上传 ZIP，随后使用 <code>POST /v1/plugins/{id}/activate</code> 激活并配置调度。</li>
        <li><strong>调度运行</strong>：运行 <code>python scripts/run_scheduler.py</code>（或接入自有调度系统）周期执行插件，采集的数据实时入库并在前端呈现。</li>
    </ol>
    <p>如需接入其他调度系统，可将调度脚本封装为 Cron/Airflow 任务执行。</p>

    <h3>完整插件示例（基于阿里云实现）</h3>
    <p>目录结构：</p>
    <pre><code>resources/
└── aliyun_security/
    ├── __init__.py
    ├── collector.py
    └── manifest.json</code></pre>

    <p><code>manifest.json</code></p>
    <pre><code>{
      "slug": "aliyun_security",
      "name": "Aliyun Bulletin Collector",
      "version": "1.0.0",
      "entrypoint": "collector:run",
  "description": "采集阿里云安全公告",
  "schedule": "3600",                         // 每 3600 秒运行一次
  "source": {
    "publisher": "Alibaba Cloud",
    "homepage": "https://t.aliyun.com",
    "feed_url": "https://t.aliyun.com/abs/bulletin/bulletinQuery"
  },
  "runtime": {
    "ingest_url": "http://127.0.0.1:8000/v1/ingest/bulletins",
    "token": "<可选 API Token>"
  }
}</code></pre>

    <p><code>collector.py</code>（核心片段）</p>
    <pre><code>API_URL = "https://t.aliyun.com/abs/bulletin/bulletinQuery"

@dataclass(slots=True)
class FetchParams:
    page_no: int = 1
    page_size: int = 50
    bulletin_type: str = "security"

class AliyunCollector:
    def fetch(self, params: FetchParams) -> list[dict]:
        response = requests.get(
            API_URL,
            params={"pageNo": params.page_no, "pageSize": params.page_size, "bulletinType": params.bulletin_type},
            timeout=30,
        )
        response.raise_for_status()
        return response.json().get("data", {}).get("info", [])

    def normalize(self, item: dict) -> BulletinCreate:
        return BulletinCreate(
            source=SourceInfo(
                source_slug="aliyun_security",
                external_id=str(item.get("id")),
                origin_url=item.get("url"),
            ),
            content=ContentInfo(
                title=item.get("titleFill") or item.get("title"),
                summary=item.get("summary"),
                body_text=item.get("content"),
                published_at=_parse_publish_time(item.get("publishTime")),
                language=item.get("language"),
            ),
            severity=item.get("securityLevel"),
            labels=[value for value in [item.get("bulletinType"), item.get("bulletinType2")] if value],
            topics=["official_bulletin"],
            extra={
                "bulletin_type": item.get("bulletinType"),
                "impact_time": item.get("impactTime"),
                "ext_info": json.loads(item.get("extInfo", "{}")),
            },
            raw=item,
        )

    def collect(self, params: FetchParams | None = None) -> list[BulletinCreate]:
        params = params or FetchParams()
        return [self.normalize(item) for item in self.fetch(params)]


def run(ingest_url: str | None = None, token: str | None = None, **runtime):
    collector = AliyunCollector()
    bulletins = collector.collect()
    if ingest_url:
        payload = [b.model_dump(mode="json") for b in bulletins]
        headers = {"Content-Type": "application/json"}
        if token:
            headers["Authorization"] = f"Bearer {token}"
        requests.post(ingest_url, json=payload, headers=headers, timeout=30)
    return bulletins
</code></pre>

    <h3>上传步骤</h3>
    <ol>
        <li>打包：<code>python scripts/package_plugins.py --output-dir dist/plugins</code>（生成 <code>aliyun_security-1.0.0.zip</code>）。</li>
        <li>如需自动上传，可带 <code>--upload-url http://127.0.0.1:8000/v1/plugins/upload</code> 与 <code>--token</code>。</li>
        <li>也可手动调用上传接口：</li>
    </ol>
    <pre><code>curl -X POST http://127.0.0.1:8000/v1/plugins/upload \
  -H "Content-Type: application/json" \
  -d '{
        "filename": "aliyun.zip",
        "content": "$(cat payload.b64)"
      }'</code></pre>

    <h3>激活与调度</h3>
    <p>上传成功后：</p>
    <pre><code># 查看状态
curl http://127.0.0.1:8000/v1/plugins

# 激活（需 manifest 提供 schedule）
curl -X POST http://127.0.0.1:8000/v1/plugins/1/activate -d '{"activate": true}' -H "Content-Type: application/json"

# 运行调度器（可加入 Cron）
python scripts/run_scheduler.py --ingest-url http://127.0.0.1:8000/v1/ingest/bulletins
</code></pre>
    <p>调度器会生成 <code>plugin_runs</code> 记录，包含开始/结束时间、状态、输出等信息。</p>
</section>
{% endblock %}
