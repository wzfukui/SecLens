{% extends "base.html" %}
{% block extra_css %}
{{ super() }}
<style>
.version-alert {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-radius: 0.75rem;
    border: 1px solid #bfdbfe;
    background: #eff6ff;
    margin-bottom: 1.5rem;
}
.version-alert p {
    margin: 0;
}
.version-alert button {
    align-self: flex-start;
    padding: 0.5rem 1.25rem;
    border-radius: 9999px;
    border: none;
    background: #1d4ed8;
    color: #fff;
    cursor: pointer;
    transition: background 0.2s ease;
}
.version-alert button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
.version-alert button:hover:not(:disabled) {
    background: #1e40af;
}
</style>
{% endblock %}
{% block content %}
<section class="static-page">
    <h2>{{ plugin.display_name or plugin.name }}</h2>
    <p class="detail-meta">
        插件标识：<code>{{ plugin.slug }}</code>
        {% if plugin.group_title %} · 分组：{{ plugin.group_title }}{% endif %}
        {% if total_items is not none %} · 采集总量：{{ total_items }}{% endif %}
    </p>
    {% if plugin.description %}
    <p>{{ plugin.description }}</p>
    {% endif %}

    {% if manifest_json %}
    <h3>Manifest</h3>
    <pre class="code-block">{{ manifest_json | safe }}</pre>
    {% endif %}

    {% if is_admin and pending_version %}
    <div class="version-alert">
        <p>检测到新的上传版本 <strong>{{ pending_version.version }}</strong>（{{ pending_version.created_at }}，当前状态：{{ pending_version.status }}）。激活后将立即替换当前版本并触发一次运行。</p>
        <button id="activate-latest" data-plugin-id="{{ plugin.id }}" data-version-id="{{ pending_version.id }}">
            激活新版本并立即运行
        </button>
    </div>
    {% endif %}

    <h3>采集趋势</h3>
    <p class="section-note">近 {{ trend_window_days }} 天采集条数</p>
    <div class="chart-wrapper">
        <canvas id="plugin-trend-chart" aria-label="近{{ trend_window_days }}天采集趋势" role="img"></canvas>
    </div>

    <h3>版本历史</h3>
    <div class="table-wrapper">
        <table class="plugins-table">
            <thead>
                <tr>
                    <th>版本</th>
                    <th>状态</th>
                    <th>调度</th>
                    <th>上传时间</th>
                    <th>激活时间</th>
                    <th>上次运行</th>
                    <th>下一次运行</th>
                </tr>
            </thead>
            <tbody>
                {% for version in versions %}
                <tr class="status-{{ version.status }}">
                    <td>{{ version.version }}</td>
                    <td>{{ version.status }}{% if version.is_active %}（激活）{% endif %}</td>
                    <td>{{ version.schedule }}</td>
                    <td>{{ version.created_at }}</td>
                    <td>{{ version.activated_at }}</td>
                    <td>{{ version.last_run_at }}</td>
                    <td>{{ version.next_run_at }}</td>
                </tr>
                {% endfor %}
                {% if not versions %}
                <tr><td colspan="7" class="empty">暂无版本信息</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <h3>最新采集</h3>
    <div class="table-wrapper">
        <table class="plugins-table">
            <thead>
                <tr>
                    <th>标题</th>
                    <th>发布时间</th>
                    <th>抓取时间</th>
                </tr>
            </thead>
            <tbody>
                {% for bulletin in recent_bulletins %}
                <tr>
                    <td><a href="/bulletins/{{ bulletin.id }}">{{ bulletin.title }}</a></td>
                    <td>{{ bulletin.published_at|display_time or '—' }}</td>
                    <td>{{ bulletin.fetched_at|display_time or '—' }}</td>
                </tr>
                {% endfor %}
                {% if not recent_bulletins %}
                <tr><td colspan="3" class="empty">暂无采集记录</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <h3>最近运行记录</h3>
    <div class="table-wrapper">
        <table class="plugins-table">
            <thead>
                <tr>
                    <th>状态</th>
                    <th>开始时间</th>
                    <th>结束时间</th>
                    <th>采集条目</th>
                    <th>新增条目</th>
                    <th>重复条目</th>
                    <th>信息</th>
                </tr>
            </thead>
            <tbody>
                {% for run in runs %}
                <tr class="status-{{ run.status }}">
                    <td>{{ run.status }}</td>
                    <td>{{ run.started_at }}</td>
                    <td>{{ run.finished_at }}</td>
                    <td>{{ run.collected if run.collected is not none else '—' }}</td>
                    <td>{{ run.accepted if run.accepted is not none else '—' }}</td>
                    <td>{{ run.duplicates if run.duplicates is not none else '—' }}</td>
                    <td>{{ run.message or '—' }}</td>
                </tr>
                {% endfor %}
                {% if not runs %}
                <tr><td colspan="7" class="empty">暂无运行记录</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="/static/vendor/chart.umd.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('plugin-trend-chart');
    const series = {{ trend_series | tojson }};
    if (canvas && Array.isArray(series) && series.length > 0 && window.Chart) {
        const labels = series.map(point => point.date.slice(5));
        const dataPoints = series.map(point => point.count);
        new window.Chart(canvas, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: '每日采集条数',
                    data: dataPoints,
                    tension: 0.2,
                    fill: true,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.15)',
                    pointRadius: 3,
                    pointBackgroundColor: '#1d4ed8',
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                        },
                    },
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        callbacks: {
                            title(items) {
                                const item = items[0];
                                if (!item) return '';
                                return series[item.dataIndex]?.date ?? '';
                            },
                            label(item) {
                                return `采集 ${item.formattedValue} 条`;
                            },
                        },
                    },
                },
            },
        });
    }

    const activateBtn = document.getElementById('activate-latest');
    if (activateBtn) {
        activateBtn.addEventListener('click', async () => {
            const pluginId = activateBtn.dataset.pluginId;
            const versionId = activateBtn.dataset.versionId;
            if (!pluginId || !versionId) return;
            const originalText = activateBtn.textContent;
            activateBtn.disabled = true;
            activateBtn.textContent = '激活中…';
            try {
                const activateResp = await fetch(`/v1/plugins/${pluginId}/activate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({activate: true, version_id: Number(versionId)}),
                });
                if (!activateResp.ok) {
                    const message = await activateResp.text();
                    throw new Error(message || activateResp.statusText);
                }
                const runResp = await fetch(`/v1/plugins/${pluginId}/run`, {method: 'POST'});
                if (!runResp.ok) {
                    const message = await runResp.text();
                    throw new Error(message || runResp.statusText);
                }
                window.location.reload();
            } catch (error) {
                alert(`激活失败：${error}`);
                activateBtn.disabled = false;
                activateBtn.textContent = originalText;
            }
        });
    }
});
</script>
{% endblock %}
